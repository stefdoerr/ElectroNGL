<!DOCTYPE html>
<html lang="en">
<head>
  <title>NGL - webapp</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <link rel="stylesheet" href="css/font-awesome.min.css" />
  <link rel="stylesheet" href="css/main.css" />
  <link rel="subresource" href="css/light.css" />
  <link rel="subresource" href="css/dark.css" />
</head>
<body>
<!-- Insert this line above script imports  -->
<script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>

<!-- normal script imports etc  -->
  <!-- NGL -->
  <script src="dist/ngl.js"></script>

  <!-- UI -->
  <script src="js/lib/signals.min.js"></script>
  <script src="js/lib/tether.min.js"></script>
  <script src="js/lib/colorpicker.min.js"></script>
  <script src="js/ui/ui.js"></script>
  <script src="js/ui/ui.extra.js"></script>
  <script src="js/ui/ui.ngl.js"></script>
  <script src="js/gui.js"></script>

<!-- Insert this line after script imports -->
<script>if (window.module) module = window.module;</script>

  <script>
    NGL.cssDirectory = "css/"
    NGL.documentationUrl = "../build/docs/"
    NGL.examplesListUrl = "../build/scriptsList.json"
    NGL.examplesScriptUrl = "./scripts/"

    // Datasources
    NGL.DatasourceRegistry.add("data", new NGL.StaticDatasource("../data/"))
    var mdsrv = NGL.getQuery("mdsrv")
    if (mdsrv) {
      var mdsrvDatasource = new NGL.MdsrvDatasource(mdsrv)
      NGL.DatasourceRegistry.add("file", mdsrvDatasource)
      NGL.setListingDatasource(mdsrvDatasource)
      NGL.setTrajectoryDatasource(mdsrvDatasource)
    }

    var stage
    document.addEventListener("DOMContentLoaded", function () {
      stage = new NGL.Stage()
      NGL.StageWidget(stage)

      var load = NGL.getQuery("load")
      if (load) stage.loadFile(load, {defaultRepresentation: true})

      var script = NGL.getQuery("script")
      if (script) stage.loadScript("./scripts/" + script + ".js")

      var struc = NGL.getQuery("struc")
      var traj = NGL.getQuery("traj")
      if (struc) {
        stage.loadFile(struc, {
          defaultRepresentation: true
        }).then(function(o) {
          if (traj) o.addTrajectory(traj)
        })
      }
    })

  </script>
</body>
<script>
    var PROTO_PATH = __dirname + '/../communication.proto';
    //var PROTO_PATH = '../communication.proto';
    var grpc = require('grpc');
    var hello_proto = grpc.load(PROTO_PATH).helloworld;

    /**
     * Implements the SayHello RPC method.
     */
    function sayHello(call, callback) {
        // stage.loadFile('rcsb://' + call.request.name + '.mmtf', {defaultRepresentation: true})

        var stringBlob = new Blob( [ call.request.name ], { type: 'text/plain'} );
        console.log(stringBlob)
        stage.loadFile( stringBlob, { ext: "pdb", name: 'Put A Name Here', defaultRepresentation: true } );
        //stage.loadFile(call.request.name, {defaultRepresentation: true})
      callback(null, {message: 'Hello ' + call.request.name});
    }

    /**
     * Starts an RPC server that receives requests for the Greeter service at the
     * sample server port
     */
    function main() {
      var server = new grpc.Server();
      server.addService(hello_proto.Greeter.service, {sayHello: sayHello});
      server.bind('0.0.0.0:50051', grpc.ServerCredentials.createInsecure());
      server.start();
    }

    main();
    console.log('Started server?')
</script>
</html>
